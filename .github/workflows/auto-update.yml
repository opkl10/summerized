name: Auto Update WordPress Plugin

on:
  push:
    branches:
      - main
    paths:
      - '**/*.php'
      - '**/*.css'
      - '**/*.js'
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get version from plugin
      id: get_version
      run: |
        VERSION=$(grep "Version:" claude-ai-summarizer.php | head -1 | sed -e 's/.*Version: *\([0-9.]*\).*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create ZIP file
      run: |
        zip -r claude-ai-summarizer-${{ steps.get_version.outputs.version }}.zip \
          claude-ai-summarizer.php \
          templates/ \
          assets/ \
          README.md \
          -x "*.git*" ".github/*"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          עדכון אוטומטי של Claude AI Summarizer WordPress Plugin
          
          ## שינויים
          - עדכון אוטומטי מ-GitHub
          - כפתור סיכום אוטומטי בפוסטים
          - שיפורי ביצועים
          
          ## התקנה
          1. הורד את הקובץ ZIP
          2. העלה ל-WordPress דרך Plugins → Add New → Upload Plugin
          3. או עדכן דרך GitHub Repository
        files: |
          claude-ai-summarizer-${{ steps.get_version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify WordPress via Webhook
      if: success()
      run: |
        echo "Release created: v${{ steps.get_version.outputs.version }}"
        if [ -n "${{ secrets.WORDPRESS_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.WORDPRESS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: release" \
            -H "X-Hub-Signature-256: sha256=$(echo -n '{"action":"published"}' | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | cut -d' ' -f2)" \
            -d '{
              "action": "published",
              "release": {
                "tag_name": "v${{ steps.get_version.outputs.version }}",
                "assets": [{
                  "browser_download_url": "https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/claude-ai-summarizer-${{ steps.get_version.outputs.version }}.zip",
                  "content_type": "application/zip",
                  "name": "claude-ai-summarizer-${{ steps.get_version.outputs.version }}.zip"
                }]
              }
            }'
        fi
